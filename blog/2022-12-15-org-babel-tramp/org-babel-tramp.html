<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-05-26 Sun 14:49 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Using a remote Python process in Org-mode files</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Jay Morgan">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" type="text/css" href="/css/general.css"/>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="preamble" class="status">
<h1 class="title">Using a remote Python process in Org-mode files</h1>
          <p class="subtitle">2022-12-15</p>
</div>
<div id="content">
<h1 class="title">Using a remote Python process in Org-mode files</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org31383d0">1. Introduction</a></li>
<li><a href="#orgce6d0f9">2. Setup</a></li>
<li><a href="#org281e328">3. Changing the Python Interpreter</a></li>
<li><a href="#orgc33d7b5">4. Plotting</a></li>
</ul>
</div>
</div>
<div id="topbar">
<img id="profile-picture" src="/images/profile.jpg" alt="Jay Paul Morgan profile picture" width="200px"/>
<h3>Dr. Jay Paul Morgan</h3>
<a href="/">About</a>
<a href="/blog">Blog Posts</a>
<a href="/publications">Publications</a>
<a href="https://pageperso.lis-lab.fr/jay.morgan/teaching.html">Teaching</a>
<a href="https://www.swansea.ac.uk/staff/j.p.morgan/">Swansea University</a>
<p id="social-links">
<a href="https://scholar.google.com/citations?user=AO1az5YAAAAJ&hl=fr"><img src="/images/google-scholar.png" alt="Jay Paul Morgan google scholar publication" width="30px" height="30px"/></a>
<a rel="me" href="https://emacs.ch/@jaymorgan"><img src="/images/mastodon.png" alt="Jay Paul Morgan Mastodon" width="30px" height="30px"/></a>
<a href="https://github.com/jaypmorgan"><img src="/images/github.png" alt="Jay Paul Morgan jaypmorgan github link" width="30px" height="30px"/></a>
<a href="https://orcid.org/my-orcid?orcid=0000-0003-3719-362X"><img src="/images/orcid.png" alt="Jay Paul Morgan orcid link" width="30px" height="30px"/></a>
<a href="https://www.researchgate.net/profile/Jay-Morgan?ev=hdr_xprf"><img src="/images/researchgate.png" alt="Jay Paul Morgan research gate social link" width="30px" height="30px"/></a>
</p>
</div>

<div id="outline-container-org31383d0" class="outline-2">
<h2 id="org31383d0"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Sometimes the work we do requires a lot of horse-power &#x2013; a lot of compute
resource. Perhaps more than what we can do locally. In these cases, we might need to
use a remote server.
</p>

<p>
In this blog post, I wanted to demonstrate how I've used a local org-mode file to
execute computations via a remote python process.
</p>
</div>
</div>

<div id="outline-container-orgce6d0f9" class="outline-2">
<h2 id="orgce6d0f9"><span class="section-number-2">2</span> Setup</h2>
<div class="outline-text-2" id="text-2">
<p>
First, we setup the location of remote server, and where the python process will be
started. I do this within the top of the org-mode file so that all python code blocks
will use this location by default. We set this up using the <code>#+PROPERTY:</code> argument:
</p>

<pre class="example" id="org3a21da4">
#+PROPERTY: header-args:python :dir /ssh:&lt;server&gt;:/path/to/dir
</pre>

<p>
We've added <code>:dir</code> that specifies the remote path using tramp. Whenever a python code
block is executed normally with <code>C-c C-c</code>, it will connect to <code>&lt;server&gt;</code> and navigate to
the <code>/path/to/dir</code> directory, start a python process, execute the source code and
return the results.
</p>

<p>
We can verify that the code block is being executed on the remote server, and find
out which python is being used by printing the hostname of the machine running the
python process, and the path to the python executable:
</p>

<pre class="example" id="orged42260">
#+begin_src python :results output
import sys
import socket
print(socket.gethostname())
print(sys.executable)
#+end_src
</pre>
</div>
</div>

<div id="outline-container-org281e328" class="outline-2">
<h2 id="org281e328"><span class="section-number-2">3</span> Changing the Python Interpreter</h2>
<div class="outline-text-2" id="text-3">
<p>
By default, the python code blocks will be executed using the first "python" command
found on the remote server's path. Often, when working with Python, we have virtual
environments.
</p>

<p>
The best (hacky) solution I've got to use the correct python environment is to
manually change the <code>org-babel-python-command</code> to the path of the virtual environment
to use:
</p>

<pre class="example" id="org7e9c4de">
#+begin_src emacs-lisp
(setq org-babel-python-command "venv/bin/python")
#+end_src
</pre>

<p>
We can then confirm that the correct virtual environment is being used by printing
the path to the executable again.
</p>

<pre class="example" id="orgbd9985b">
#+begin_src python :results output
import socket
print(sys.executable)
#+end_src
</pre>
</div>
</div>

<div id="outline-container-orgc33d7b5" class="outline-2">
<h2 id="orgc33d7b5"><span class="section-number-2">4</span> Plotting</h2>
<div class="outline-text-2" id="text-4">
<p>
Alas there is still a pain point: plotting. When we execute a code block and specify
that it returns a file (the path to the newly created plot), it will return a path on
the local machine. Of course, this doesn't exist as it was executed on the remote
server. Take for example:
</p>

<pre class="example" id="org4bf3f6c">
#+begin_src python :results file
import matplotlib.pyplot as plt
import numpy as np
x = np.arange(0, 10)
y = np.random.randn(*x.shape) + x
plt.plot(x, y, 'r--')
plt.savefig("/tmp/test.png")
"/tmp/test.png"
#+end_src

#+RESULTS:
file:/tmp/testplot.png
</pre>

<p>
This will not work. Instead, a workaround I've created is creating a named code block
to save and return the remote path:
</p>

<pre class="example" id="orgb4d3129">
#+name: savefig
#+begin_src python :session testing :var filename="/tmp/plot.png"
f"""
plt.savefig('{filename}')
plt.close()
'/ssh:&lt;server&gt;:{filename}'
"""
#+end_src

#+RESULTS: savefig

: plt.savefig('/tmp/plot.png')
: plt.close()
: '/ssh:&lt;server&gt;:/tmp/plot.png'
</pre>

<p>
Then when we want to create a plot:
</p>

<pre class="example" id="org23d3123">
#+begin_src python :results file :noweb strip-export
import matplotlib.pyplot as plt
import numpy as np
x = np.arange(0, 10)
y = np.random.randn(*x.shape) + x
plt.plot(x, y, 'r--')
&lt;&lt;savefig(filename="/tmp/testplot.png")&gt;&gt;
#+end_src

#+RESULTS:
file:/ssh:&lt;server&gt;:/tmp/testplot.png]]
</pre>

<p>
We won't be able to see the image within the notebook itself, but we can use <code>C-c C-o</code>
to open the file into it's own buffer, which is the best solution I've come up with
for the moment.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2022-12-15</p>
<p class="author">Author: Jay Morgan</p>
<p class="date">Created: 2024-05-26 Sun 14:49</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
